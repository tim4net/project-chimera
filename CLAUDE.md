# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Project Chimera is a semi-idle RPG powered by an AI Dungeon Master. The project uses a hybrid AI architecture combining:
- **Gemini Pro**: A powerful cloud-based LLM for high-stakes creative tasks (major plot points, world generation)
- **Local LLM**: Running on project infrastructure for high-frequency routine tasks (minor descriptions, NPC chatter)

The game features dual interfaces (web application and Discord bot) and supports both solo and multiplayer gameplay within a persistent, procedurally generated world. The project implements D&D 5e mechanics adapted for semi-idle gameplay.

## Architecture

### Database: Self-Hosted Supabase
- The project uses a **containerized, self-hosted version of Supabase** (open-source Firebase alternative)
- Provides PostgreSQL database with built-in RESTful APIs and real-time capabilities
- All data remains within the project's local environment
- Supabase stack runs via Podman containers managed through `docker-compose`
- Located in: `supabase/docker/docker-compose.yml`

### Key Components
1. **Backend Server**: Manages game logic, rules adjudication (5e mechanics), game state, and AI communication
2. **Database (Supabase)**: PostgreSQL with RESTful APIs, allowing direct interaction from web/Discord frontends
3. **Web Frontend**: Primary UI displaying procedurally generated map, character sheets, and game logs (planned React app)
4. **Discord Bot**: Secondary interface for notifications, narrative updates, and quick actions (planned)

### Hybrid AI System
- **Gemini Pro**: Reserved for one-time high-impact moments (character onboarding, major story arcs, NPC persona generation)
- **Local LLM**: Handles frequent tasks (travel narration, radiant quests, routine NPC conversations)
- Conversation handoff protocol ensures consistency while minimizing API costs

## Development Commands

### Fresh Start Workflow

When starting fresh or fixing issues with the setup:

```bash
# 1. Clean up previous build artifacts
./clean_start.sh

# 2. Verify the setup
./verify_setup.sh

# 3. Run the orchestrator (if verification passes)
./build_orchestrator.sh
```

### Container Management
```bash
# Start Supabase containers
podman compose -f supabase/docker/docker-compose.yml up -d

# Stop Supabase containers
podman compose -f supabase/docker/docker-compose.yml down

# Check container status
podman compose -f supabase/docker/docker-compose.yml ps

# View logs
podman compose -f supabase/docker/docker-compose.yml logs -f

# Reset Supabase environment
./supabase/docker/reset.sh
```

### Infrastructure Scripts

**build_orchestrator.sh** - AI-driven build automation script
- Automatically sets up Supabase infrastructure
- Fixes Docker registry prefixes for Podman compatibility
- Self-healing: detects and fixes configuration issues
- Includes retry logic for network failures
- Runs verification checks before starting

**verify_setup.sh** - Infrastructure verification script
- Checks project structure and required files
- Verifies Docker Compose registry configuration
- Validates environment variables
- Confirms Git repository status
- Validates orchestrator script syntax
- Checks Supabase container health

**clean_start.sh** - Cleanup script for fresh starts
- Stops all Supabase containers
- Removes backup files created by sed
- Resets state files (project_state.json, logs, etc.)
- Restores original docker-compose.yml from backup or git
- Prepares environment for clean orchestrator run

## Core Design Principles

### 1. Dual-Phase Gameplay
- **Idle Phase**: Abstract, single-roll resolution for background tasks (travel, crafting, minor encounters)
- **Active Phase**: Asynchronous turn-based tactical combat for major encounters

### 2. Layered Quest Generation
- **Layer 1 (Radiant Quests)**: Template-based, procedurally-filled quests using Local LLM
- **Layer 2 (Faction Quests)**: AI-generated multi-step quests responding to world state
- **Layer 3 (Story Arcs)**: Epic narratives generated by Gemini Pro during world creation

### 3. Multi-Vector Progression
- Experience & Leveling (5e XP system)
- Loot & Equipment (including AI-generated unique properties)
- Reputation (faction standing)
- Knowledge (crafting recipes, lore discoveries)

### 4. World Evolution (Epoch System)
- Major story arc completions trigger "Epoch Events"
- Gemini Pro generates historical records of player achievements
- World state changes permanently (new POIs, faction shifts, NPC changes)
- Creates dynamic, evolving narrative rather than static content

### 5. UI/UX Philosophy: Text-First, Map-Centric
- Minimalist design prioritizing AI-generated narrative
- Central dashboard with interactive map and journal feed
- Dedicated screens: Character, Journal, Social, Active Phase overlay
- Inspired by classic MUDs (Multi-User Dungeons)

## MVP Scope

The current development focuses on the **Minimum Viable Product** with these constraints:
- **Solo player experience only** (multiplayer postponed)
- Core gameplay loop: Idle Phase → Active Phase → Resolution
- Only Travel and Scout idle tasks implemented
- Template-based radiant quests only (Layer 1)
- Web UI with map, fog of war, and journal feed
- Single Gemini Pro call for personalized onboarding
- Local LLM for all other narration
- Basic XP and non-magical loot

**Explicitly excluded from MVP**: Multiplayer/party systems, portal system, faction/reputation, major NPCs, Discord bot, world epochs, advanced crafting.

## Important Files

- `project.md`: Complete Architectural Decision Records (ADRs) documenting all design decisions
- `GEMINI.md`: Project overview and development conventions (lighter version)
- `CLAUDE.md`: This file - guidance for Claude Code agents
- `build_orchestrator.sh`: AI-driven build automation with self-healing capabilities
- `verify_setup.sh`: Infrastructure verification script for quality assurance
- `clean_start.sh`: Cleanup script to reset environment to fresh state
- `project_state.json`: Tracks orchestrator execution state
- `bug_reports.txt`: Logs command failures and errors for debugging
- `build.log`: Complete execution log of orchestrator runs
- `supabase/docker/docker-compose.yml`: Supabase container configuration (modified by orchestrator for Podman registry compatibility)
- `supabase/docker/.env`: Supabase environment configuration

## Git Workflow

- Repository: `project-chimera` (user: tim4net)
- The build orchestrator automatically commits and pushes changes
- Uses conventional commit messages describing executed plans

## Technology Stack

- **Container Runtime**: Podman (Docker alternative)
- **Database**: PostgreSQL via Supabase
- **AI Models**: Gemini Pro (cloud) + Local LLM (planned)
- **Frontend**: React (planned, not yet implemented)
- **Backend**: To be determined (Python/Flask or Node.js/Express per ADRs)

## Development Notes

- All Supabase-related work uses the cloned supabase repository in `/srv/project-chimera/supabase`
- The project is containerized and portable via Docker/Podman
- Cost optimization is a key concern: minimize expensive Gemini Pro API calls
- Supabase provides direct database access from frontends, reducing backend API complexity
- The project prioritizes self-contained, self-hosted infrastructure over cloud services
