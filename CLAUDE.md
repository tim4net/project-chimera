# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Project Chimera is a semi-idle RPG powered by an AI Dungeon Master. The project uses a hybrid AI architecture combining:
- **Gemini Pro**: A powerful cloud-based LLM for high-stakes creative tasks (major plot points, world generation)
- **Local LLM**: Running on project infrastructure for high-frequency routine tasks (minor descriptions, NPC chatter)

The game features dual interfaces (web application and Discord bot) and supports both solo and multiplayer gameplay within a persistent, procedurally generated world. The project implements D&D 5e mechanics adapted for semi-idle gameplay.

## Architecture

### Database: Supabase Cloud
- The project uses **Supabase Cloud** (hosted PostgreSQL with RESTful APIs)
- Provides PostgreSQL database with built-in RESTful APIs and real-time capabilities
- Project URL: https://muhlitkerrjparpcuwmc.supabase.co
- Connection details stored in `.env` files (not committed to git)
- See `SUPABASE_CLOUD_CREDENTIALS.md` for full configuration details

### Key Components
1. **Backend Server**: Manages game logic, rules adjudication (5e mechanics), game state, and AI communication
2. **Database (Supabase Cloud)**: PostgreSQL with RESTful APIs, allowing direct interaction from web/Discord frontends
3. **Web Frontend**: Primary UI displaying procedurally generated map, character sheets, and game logs (React/Vite app)
4. **Discord Bot**: Secondary interface for notifications, narrative updates, and quick actions (planned)

### Hybrid AI System
- **Gemini Pro**: Reserved for one-time high-impact moments (character onboarding, major story arcs, NPC persona generation)
- **Local LLM**: Handles frequent tasks (travel narration, radiant quests, routine NPC conversations)
- Conversation handoff protocol ensures consistency while minimizing API costs

## Development Commands

### Fresh Start Workflow

When starting fresh or fixing issues with the setup:

```bash
# 1. Clean up previous build artifacts
./clean_start.sh

# 2. Verify the setup
./verify_setup.sh

# 3. Run the orchestrator
./build_orchestrator.sh

# OR: Run in continuous self-healing mode
./run_continuous.sh
```

**Continuous Mode**: The orchestrator runs in an infinite loop, automatically retrying on failures and monitoring for new tasks. This is the recommended mode for autonomous, unattended development.

### Container Management
```bash
# Start frontend and backend containers
podman compose up -d

# Stop containers
podman compose down

# Check container status
podman compose ps

# View logs
podman compose logs -f

# Rebuild containers
podman compose build
```

### Infrastructure Scripts

**build_orchestrator.sh** - Dual-AI build automation (Gemini + Claude) (v17)
- **Gemini Integration**: Generates build plans from ARCHITECTURE_TASKS.md
- **Claude Error Recovery**: Analyzes failures and generates fixes automatically
- **4-Step TDD Workflow**: Define Tests → Implement → Test → Review (iterative)
- **Verbose Output**: Progress spinners, streaming output for long commands, detailed status
- **Self-Healing**: Auto-retries with fresh context on failures
- **State Tracking**: JSON-based task completion tracking with jq
- **Continuous Mode**: Designed to run in infinite loop without exits
- **Smart Parsing**: Filters Gemini output to extract only executable commands

**run_continuous.sh** - Wrapper for continuous autonomous build mode
- Runs orchestrator in infinite loop
- Monitors completion status
- Automatic retry after failures
- Designed for unattended operation

**verify_setup.sh** - Infrastructure verification script
- Checks project structure and required files
- Verifies Docker Compose registry configuration
- Validates environment variables
- Confirms Git repository status
- Validates orchestrator script syntax
- Checks Supabase container health

**clean_start.sh** - Cleanup script for fresh starts
- Stops all containers
- Removes backup files created by sed
- Resets state files (project_state.json, logs, etc.)
- Restores original docker-compose.yml from backup or git
- Prepares environment for clean orchestrator run

## Core Design Principles

### 1. Dual-Phase Gameplay
- **Idle Phase**: Abstract, single-roll resolution for background tasks (travel, crafting, minor encounters)
- **Active Phase**: Asynchronous turn-based tactical combat for major encounters

### 2. Layered Quest Generation
- **Layer 1 (Radiant Quests)**: Template-based, procedurally-filled quests using Local LLM
- **Layer 2 (Faction Quests)**: AI-generated multi-step quests responding to world state
- **Layer 3 (Story Arcs)**: Epic narratives generated by Gemini Pro during world creation

### 3. Multi-Vector Progression
- Experience & Leveling (5e XP system)
- Loot & Equipment (including AI-generated unique properties)
- Reputation (faction standing)
- Knowledge (crafting recipes, lore discoveries)

### 4. World Evolution (Epoch System)
- Major story arc completions trigger "Epoch Events"
- Gemini Pro generates historical records of player achievements
- World state changes permanently (new POIs, faction shifts, NPC changes)
- Creates dynamic, evolving narrative rather than static content

### 5. UI/UX Philosophy: Text-First, Map-Centric
- Minimalist design prioritizing AI-generated narrative
- Central dashboard with interactive map and journal feed
- Dedicated screens: Character, Journal, Social, Active Phase overlay
- Inspired by classic MUDs (Multi-User Dungeons)

## MVP Scope

The current development focuses on the **Minimum Viable Product** with these constraints:
- **Solo player experience only** (multiplayer postponed)
- Core gameplay loop: Idle Phase → Active Phase → Resolution
- Only Travel and Scout idle tasks implemented
- Template-based radiant quests only (Layer 1)
- Web UI with map, fog of war, and journal feed
- Single Gemini Pro call for personalized onboarding
- Local LLM for all other narration
- Basic XP and non-magical loot

**Explicitly excluded from MVP**: Multiplayer/party systems, portal system, faction/reputation, major NPCs, Discord bot, world epochs, advanced crafting.

## Important Files

### Documentation
- `project.md`: Complete Architectural Decision Records (ADRs) documenting all design decisions
- `GEMINI.md`: Project overview and development conventions (lighter version)
- `CLAUDE.md`: This file - guidance for Claude Code agents
- `ARCHITECTURE_TASKS.md`: Complete MVP task breakdown with IDs and dependencies (763 lines)
- `TASK_WORKFLOW.md`: 4-step TDD workflow for AI-driven development
- `FIXES.md`: Documentation of orchestrator bug fixes

### Scripts
- `build_orchestrator.sh`: AI-driven build automation with Gemini integration (v16)
- `verify_setup.sh`: Infrastructure verification script for quality assurance
- `clean_start.sh`: Cleanup script to reset environment to fresh state

### State and Logs
- `project_state.json`: Enhanced JSON state tracking with task completion arrays
- `bug_reports.txt`: Logs command failures and errors for debugging
- `build.log`: Complete execution log of orchestrator runs
- `prompts/`: Directory for AI prompts (created by orchestrator)
- `test_results/`: Test specifications, implementations, and verification logs

### Configuration
- `docker-compose.yml`: Container configuration for frontend and backend services
- `.env`: Root environment variables (Supabase Cloud credentials, Gemini API key)
- `frontend/.env`: Frontend-specific environment variables (Vite prefixed)
- `SUPABASE_CLOUD_CREDENTIALS.md`: Supabase Cloud project details and credentials (⚠️ contains secrets, should not be committed publicly)

## Git Workflow

- Repository: `project-chimera` (user: tim4net)
- The build orchestrator automatically commits and pushes changes
- Uses conventional commit messages describing executed plans

## Technology Stack

- **Container Runtime**: Podman (Docker alternative)
- **Database**: PostgreSQL via Supabase
- **AI Models**: Gemini Pro (cloud) + Local LLM (planned)
- **Frontend**: React (planned, not yet implemented)
- **Backend**: To be determined (Python/Flask or Node.js/Express per ADRs)

## Development Notes

- Supabase Cloud instance is located at: https://muhlitkerrjparpcuwmc.supabase.co
- The project is containerized and portable via Docker/Podman
- Cost optimization is a key concern: minimize expensive Gemini Pro API calls
- Supabase provides direct database access from frontends, reducing backend API complexity
- Database migrations are managed through Supabase's SQL Editor or CLI
- Use 'podman compose' not 'podman-compose'